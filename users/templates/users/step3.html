{% extends 'base.html' %}
{% load static %}

{% block content %}
    <div class="container bg-white p-4">
        <h2>Шаг 3: Добавление участников</h2>
        <form method="post">
            {% csrf_token %}

            <h3>Добавить участника:</h3>

            <div class="mb-3">
                <label for="{{ add_participant_form.full_name.id_for_label }}" class="form-label">{{ add_participant_form.full_name.label }}:</label>
                {{ add_participant_form.full_name.errors }}
                <input type="text" class="form-control" id="{{ add_participant_form.full_name.id_for_label }}" name="{{ add_participant_form.full_name.html_name }}" value="{{ add_participant_form.full_name.value|default_if_none:"" }}" {% if add_participant_form.full_name.field.required %}required{% endif %}>
                 {% if add_participant_form.full_name.errors %}
                    <div class="alert alert-danger">{{ add_participant_form.full_name.errors }}</div>
                {% endif %}
            </div>

            <div class="mb-3">
                <label for="{{ add_participant_form.birth_date.id_for_label }}" class="form-label">{{ add_participant_form.birth_date.label }}:</label>
                {{ add_participant_form.birth_date.errors }}
                 <input type="date" class="form-control" id="{{ add_participant_form.birth_date.id_for_label }}" name="{{ add_participant_form.birth_date.html_name }}" value="{{ add_participant_form.birth_date.value|date:'Y-m-d'|default_if_none:"" }}" {% if add_participant_form.birth_date.field.required %}required{% endif %}>
                {% if add_participant_form.birth_date.errors %}
                    <div class="alert alert-danger">{{ add_participant_form.birth_date.errors }}</div>
                {% endif %}
            </div>

            <div class="mb-3">
                <label for="{{ add_participant_form.participation_type.id_for_label }}" class="form-label">{{ add_participant_form.participation_type.label }}:</label>
                {{ add_participant_form.participation_type.errors }}
                <select class="form-select" id="{{ add_participant_form.participation_type.id_for_label }}" name="{{ add_participant_form.participation_type.html_name }}">
                    {% for value, label in add_participant_form.participation_type.field.choices %}
                        <option value="{{ value }}" {% if add_participant_form.participation_type.value == value %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
                {% if add_participant_form.participation_type.errors %}
                    <div class="alert alert-danger">{{ add_participant_form.participation_type.errors }}</div>
                {% endif %}
            </div>

            {# School fields #}
            <div id="school-fields" class="mb-3" {% if add_participant_form.participation_type.value != 'school' %}style="display: none;"{% endif %}>
                <div class="mb-3">
                    <label for="{{ add_participant_form.school.id_for_label }}" class="form-label">{{ add_participant_form.school.label }}:</label>
                    {{ add_participant_form.school.errors }}
                    <input type="text" class="form-control" id="{{ add_participant_form.school.id_for_label }}" name="{{ add_participant_form.school.html_name }}" value="{{ add_participant_form.school.value|default_if_none:"" }}">
                    {% if add_participant_form.school.errors %}
                        <div class="alert alert-danger">{{ add_participant_form.school.errors }}</div>
                    {% endif %}
                </div>
                <div class="mb-3">
                    <label for="{{ add_participant_form.grade.id_for_label }}" class="form-label">{{ add_participant_form.grade.label }}:</label>
                    {{ add_participant_form.grade.errors }}
                     <input type="text" class="form-control" id="{{ add_participant_form.grade.id_for_label }}" name="{{ add_participant_form.grade.html_name }}" value="{{ add_participant_form.grade.value|default_if_none:"" }}">
                    {% if add_participant_form.grade.errors %}
                        <div class="alert alert-danger">{{ add_participant_form.grade.errors }}</div>
                    {% endif %}
                </div>
            </div>

            {# Additional Education fields #}
            <div id="additional-education-fields" class="mb-3" {% if add_participant_form.participation_type.value != 'additional_education' %}style="display: none;"{% endif %}>
                <div class="mb-3">
                    <label for="{{ add_participant_form.additional_education_name.id_for_label }}" class="form-label">{{ add_participant_form.additional_education_name.label }}:</label>
                    {{ add_participant_form.additional_education_name.errors }}
                     <input type="text" class="form-control" id="{{ add_participant_form.additional_education_name.id_for_label }}" name="{{ add_participant_form.additional_education_name.html_name }}" value="{{ add_participant_form.additional_education_name.value|default_if_none:"" }}">
                    {% if add_participant_form.additional_education_name.errors %}
                        <div class="alert alert-danger">{{ add_participant_form.additional_education_name.errors }}</div>
                    {% endif %}
                </div>
                <div class="mb-3">
                    <label for="{{ add_participant_form.age.id_for_label }}" class="form-label">{{ add_participant_form.age.label }}:</label>
                    {{ add_participant_form.age.errors }}
                     <input type="number" class="form-control" id="{{ add_participant_form.age.id_for_label }}" name="{{ add_participant_form.age.html_name }}" value="{{ add_participant_form.age.value|default_if_none:"" }}">
                    {% if add_participant_form.age.errors %}
                        <div class="alert alert-danger">{{ add_participant_form.age.errors }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="mb-3">
                <label for="{{ add_participant_form.project.id_for_label }}" class="form-label">{{ add_participant_form.project.label }}:</label>
                {{ add_participant_form.project.errors }}
                 <input type="text" class="form-control" id="{{ add_participant_form.project.id_for_label }}" name="{{ add_participant_form.project.html_name }}" value="{{ add_participant_form.project.value|default_if_none:"" }}">
                {% if add_participant_form.project.errors %}
                    <div class="alert alert-danger">{{ add_participant_form.project.errors }}</div>
                {% endif %}
            </div>

            <button type="submit" name="add_participant" class="btn btn-success">Добавить участника</button>

            <h3>Список участников:</h3>
            {% if participants %}
                <ul class="list-group">
                    {% for participant in participants %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ participant.full_name }} - {{ participant.birth_date }} -
                            {% if participant.participation_type == 'school' %}
                                Школа: {{ participant.school|default_if_none:"" }} ({{ participant.grade|default_if_none:"" }})
                            {% elif participant.participation_type == 'additional_education' %}
                                Учреждение: {{ participant.additional_education_name|default_if_none:"" }} (Возраст: {{ participant.age|default_if_none:"" }})
                            {% endif %}
                            <button type="submit" name="remove_participant" value="{{ forloop.counter0 }}" class="btn btn-danger btn-sm">Удалить</button>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p>Пока нет ни одного участника.</p>
            {% endif %}

            <button type="submit" name="complete_step3" class="btn btn-primary mt-3">Далее</button>
        </form>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const participationTypeSelect = document.getElementById('id_participation_type');
            const schoolFields = document.getElementById('school-fields');
            const additionalEducationFields = document.getElementById('additional-education-fields');

            function updateFieldsVisibility() {
                const selectedValue = participationTypeSelect.value;

                if (selectedValue === 'school') {
                    schoolFields.style.display = 'block';
                    additionalEducationFields.style.display = 'none';
                } else if (selectedValue === 'additional_education') {
                    schoolFields.style.display = 'none';
                    additionalEducationFields.style.display = 'block';
                } else {
                    schoolFields.style.display = 'none';
                    additionalEducationFields.style.display = 'none';
                }
            }

            // Initial visibility on page load
            updateFieldsVisibility();

            // Update visibility on select change
            participationTypeSelect.addEventListener('change', updateFieldsVisibility);
        });
    </script>
{% endblock %}